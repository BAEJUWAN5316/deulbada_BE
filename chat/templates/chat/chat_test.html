<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Local WebSocket Test</title>
</head>
<body>
    <h1>WebSocket í…ŒìŠ¤íŠ¸ - ìˆ˜ì •</h1>
    
    <div id="chatSection">
        <h3>ì±„íŒ…</h3>
        <p><span id="tokenDisplay">ë¡œë”©ì¤‘...</span></p>
        <button id="connectBtn">WebSocket ì—°ê²°</button>
        <button id="sendBtn" disabled>ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>
        <button id="sendImageBtn" disabled>ì´ë¯¸ì§€ ë³´ë‚´ê¸°</button>
        <input type="file" id="imageInput" accept="image/*" style="display:none;">
        <ul id="messages"></ul>
    </div>

    <script>
        let socket;
        let authToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzU1MTU5MzA4LCJpYXQiOjE3NTUxNTc1MDgsImp0aSI6IjcyOTdlNWNiYmYwZTRkOGE5MTI4NDQ1YjY0NWMyMDgwIiwidXNlcl9pZCI6IjEiLCJhY2NvdW50X2lkIjpudWxsLCJ1c2VybmFtZSI6bnVsbH0.6AwVto5Lwl19m7qCVipDEF2AyLuQdEgjzTzHokBcF0E";

        // DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM ë¡œë“œ ì™„ë£Œ");
            
            // í† í° í‘œì‹œ
            const tokenDisplay = document.getElementById('tokenDisplay');
            if (authToken !== "ì—¬ê¸°ì—_JWT_í† í°ì„_ë„£ì–´ì£¼ì„¸ìš”") {
                tokenDisplay.textContent = authToken.substring(0, 20) + "...";
                tokenDisplay.style.color = "green";
            } else {
                tokenDisplay.textContent = "í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤";
                tokenDisplay.style.color = "red";
            }
            
            function addMessage(text, imageUrl = null) {
                const ul = document.getElementById("messages");
                if (!ul) {
                    console.error("messages ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                    return;
                }
                const li = document.createElement("li");
                li.innerHTML = new Date().toLocaleTimeString() + " - " + text;
                
                // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì´ë¯¸ì§€ í‘œì‹œ
                if (imageUrl) {
                    const img = document.createElement("img");
                    img.src = imageUrl;
                    img.style.maxWidth = "200px";
                    img.style.maxHeight = "200px";
                    img.style.display = "block";
                    img.style.marginTop = "5px";
                    li.appendChild(img);
                }
                
                ul.appendChild(li);
                console.log("ë©”ì‹œì§€ ì¶”ê°€ë¨:", text, imageUrl ? "ì´ë¯¸ì§€ í¬í•¨" : "");
            }

            function sendMessage() {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    const message = { message: "JWT í† í° í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€" };
                    socket.send(JSON.stringify(message));
                    console.log("ğŸ“¤ ì „ì†¡í•œ ë©”ì‹œì§€:", message);
                    addMessage("ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡: " + message.message);
                } else {
                    console.log("âŒ WebSocketì´ ì—°ê²°ë˜ì§€ ì•ŠìŒ");
                    addMessage("WebSocket ì—°ê²°ë˜ì§€ ì•ŠìŒ!");
                }
            }

            function connectWebSocket() {
                if (authToken === "ì—¬ê¸°ì—_JWT_í† í°ì„_ë„£ì–´ì£¼ì„¸ìš”") {
                    addMessage("âŒ JWT í† í°ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!");
                    return;
                }

                addMessage("ğŸ”„ WebSocket ì—°ê²° ì‹œë„ì¤‘...");

                // WebSocket ì—°ê²° ì‹œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ í† í° ì „ì†¡
                socket = new WebSocket(`ws://localhost:8000/ws/chat/1/?token=${authToken}`);

                socket.onopen = () => {
                    console.log("âœ… ì—°ê²° ì„±ê³µ");
                    addMessage("âœ… ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('sendImageBtn').disabled = false;
                    document.getElementById('connectBtn').textContent = "ì—°ê²°ë¨";
                    document.getElementById('connectBtn').disabled = true;
                };

                socket.onmessage = (e) => {
                    console.log("ğŸ“© ì›ë³¸ ë°ì´í„°:", e.data);
                    try {
                        const data = JSON.parse(e.data);
                        console.log("ğŸ“© íŒŒì‹±ëœ ë°ì´í„°:", data);
                        
                        let messageText = `ğŸ“© [${data.sender}]: ${data.message || ''}`;
                        if (data.image_url) {
                            messageText += " [ì´ë¯¸ì§€]";
                        }
                        
                        addMessage(messageText, data.image_url);
                    } catch (error) {
                        console.log("ğŸ“© JSON íŒŒì‹± ì‹¤íŒ¨, ì›ë³¸ í…ìŠ¤íŠ¸:", e.data);
                        addMessage("ğŸ“© ë°›ì€ ë©”ì‹œì§€: " + e.data);
                    }
                };

                socket.onerror = (e) => {
                    console.error("âŒ ì˜¤ë¥˜:", e);
                    addMessage("âŒ WebSocket ì˜¤ë¥˜ ë°œìƒ!");
                };

                socket.onclose = (e) => {
                    console.log("ğŸ”Œ ì—°ê²° ì¢…ë£Œ:", e.code, e.reason);
                    addMessage(`ğŸ”Œ ì—°ê²° ì¢…ë£Œë¨: ${e.code} - ${e.reason || 'Unknown'}`);
                    document.getElementById('sendBtn').disabled = true;
                    document.getElementById('sendImageBtn').disabled = true;
                    document.getElementById('connectBtn').textContent = "WebSocket ì—°ê²°";
                    document.getElementById('connectBtn').disabled = false;
                };
            }

            // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì „ì†¡ í•¨ìˆ˜
            async function uploadAndSendImage(file) {
                try {
                    addMessage("ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...");
                    
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const response = await fetch('/api/uploads/images/', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log("âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:", data);
                        
                        // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ URLì„ WebSocketìœ¼ë¡œ ì „ì†¡
                        const imageUrl = data.image.startsWith('http') ? data.image : `${data.image}`;
                        const message = {
                            message: "ì´ë¯¸ì§€ë¥¼ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.",
                            image_url: imageUrl
                        };
                        
                        if (socket && socket.readyState === WebSocket.OPEN) {
                            socket.send(JSON.stringify(message));
                            console.log("ğŸ“¤ ì „ì†¡í•œ ì´ë¯¸ì§€ ë©”ì‹œì§€:", message);
                            addMessage("ğŸ“¤ ì´ë¯¸ì§€ ì „ì†¡ ì™„ë£Œ", imageUrl);
                        } else {
                            addMessage("âŒ WebSocket ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤!");
                        }
                        
                    } else {
                        const errorData = await response.text();
                        console.error("âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:", response.status, response.statusText, errorData);
                        addMessage(`âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${response.status} - ${errorData}`);
                    }
                } catch (error) {
                    console.error("âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
                    addMessage("âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜!");
                }
            }

            function sendImageMessage() {
                const imageInput = document.getElementById('imageInput');
                imageInput.click();
            }

            // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            const connectBtn = document.getElementById("connectBtn");
            const sendBtn = document.getElementById("sendBtn");
            const sendImageBtn = document.getElementById("sendImageBtn");
            const imageInput = document.getElementById("imageInput");
            
            if (connectBtn) {
                connectBtn.addEventListener('click', connectWebSocket);
            }
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            if (sendImageBtn) {
                sendImageBtn.addEventListener('click', sendImageMessage);
            }
            if (imageInput) {
                imageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        uploadAndSendImage(file);
                    }
                });
            }
        });
    </script>
</body>
</html>